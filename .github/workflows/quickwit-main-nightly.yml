name: Build quickwit from main

on:
  # 手动触发
  workflow_dispatch:

  # 可选：每天构建一次 main 分支的 nightly
  schedule:
    - cron: "0 18 * * *"  # 例子：每天 18:00 UTC 触发（你可以按自己时区改）

  # 可选：当你在 fork 的 main push 时也触发
  push:
    branches:
      - main

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          # 从上游同步后，fork 的 main 就是最新 main
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            protobuf-compiler \
            cmake

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        # 如果后面发现 main 需要特定版本，可以在这里 pin 比如:
        # with:
        #   toolchain: 1.79.0

      - name: Show Rust version
        run: rustc --version && cargo --version

      - name: Build quickwit (release)
        env:
          # 如需避免某些 lock 问题，可以禁用 incremental
          CARGO_INCREMENTAL: 0
        run: |
          # 按社区文章做法，从仓库根目录直接构建 release
          cargo build --release
          ls -lh target/release

      - name: Package binary
        run: |
          mkdir -p dist
          # Quickwit CLI 二进制一般叫 quickwit
          cp target/release/quickwit dist/
          # 尝试 strip，失败也忽略
          strip dist/quickwit || true
          cd dist
          tar czf ../quickwit-main-${GITHUB_SHA}-linux-amd64.tar.gz quickwit

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickwit-main-linux-amd64-${{ github.sha }}
          path: quickwit-main-${{ github.sha }}-linux-amd64.tar.gz
          retention-days: 7
