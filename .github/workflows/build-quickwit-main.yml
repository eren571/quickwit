name: Build Quickwit main (glibc 2.34)

on:
  workflow_dispatch:

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest
    container:
      image: public.ecr.aws/amazonlinux/amazonlinux:2023

    steps:
      - name: Install build dependencies
        shell: bash
        run: |
          set -euxo pipefail
          cat /etc/os-release

          # 先确保 CA/基础工具在（有些情况下 repo https 会报 curl 60）
          dnf -y clean all
          dnf -y makecache --refresh || true

          dnf -y install \
            git \
            gcc \
            gcc-c++ \
            make \
            cmake \
            pkgconf-pkg-config \
            openssl-devel \
            protobuf-compiler \
            tar \
            gzip \
            xz \
            curl \
            ca-certificates \
            python3 \
            llvm-devel \
            clang19 \
            clang19-devel

          update-ca-trust || true

      - name: Checkout quickwit
        uses: actions/checkout@v4
        with:
          repository: quickwit-oss/quickwit
          ref: main
          fetch-depth: 1

      # ✅ 1) 安装 Node（参考官方 UI workflow：node 20）
      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "yarn"
          cache-dependency-path: quickwit/quickwit-ui/yarn.lock

      # ✅ 2) 准备 yarn（node20 用 corepack 最稳）
      - name: Enable yarn (corepack)
        run: |
          corepack enable
          yarn --version

      # ✅ 3) 构建 UI（关键：发生在 cargo build 之前）
      - name: Build Quickwit UI
        working-directory: quickwit
        run: |
          yarn --cwd quickwit-ui install --frozen-lockfile
          CI=false yarn --cwd quickwit-ui build

      - name: Install Rust (stable)
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
            | sh -s -- -y --profile minimal --default-toolchain stable
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Show Rust toolchain
        run: |
          rustc -V
          cargo -V
          ldd --version

      # ✅ 4) 再编译 quickwit
      - name: Build quickwit binary
        working-directory: quickwit
        env:
          CARGO_INCREMENTAL: 0
        run: |
          cargo build --release --bin quickwit --features release-feature-set
          ls -lh target/release/
          strip target/release/quickwit || true
          mkdir -p artifacts
          cp target/release/quickwit artifacts/quickwit-main-al2023-amd64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: quickwit-main-al2023-amd64
          path: quickwit/artifacts/quickwit-main-al2023-amd64
